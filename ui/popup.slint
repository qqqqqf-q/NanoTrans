// NanoTrans Translation Popup UI
// Modern, frameless popup window for displaying translations

import { VerticalBox, HorizontalBox, ComboBox } from "std-widgets.slint";
import { Theme } from "./theme.slint";

export component TranslatePopup inherits Window {
    // Window properties
    no-frame: true;
    always-on-top: true;
    width: 380px;
    min-height: 160px;
    background: transparent;

    // Input properties
    in property <string> source-text: "";
    in property <string> translated-text: "";
    in property <bool> loading: false;
    in property <string> error-message: "";
    in-out property <int> current-provider-index: 0;
    in property <[string]> provider-list: ["Google", "DeepL", "LLM"];

    // I18N text properties
    in property <string> i18n-provider-label: "Provider:";
    in property <string> i18n-translating: "Translating...";
    in property <string> i18n-copy: "Copy";
    in property <string> i18n-apply: "Apply";
    in property <string> i18n-hint: "Click result or press Enter to apply";

    // Output callbacks
    callback apply-translation();
    callback close-popup();
    callback copy-result();
    callback provider-changed(int);
    callback open-settings();
    callback drag-window(int, int);

    // 拖动状态
    property <bool> dragging: false;

    // Main container with rounded corners
    Rectangle {
        x: 4px;
        y: 4px;
        width: parent.width - 8px;
        height: parent.height - 8px;
        background: Theme.background-elevated;
        border-radius: Theme.radius-large;
        border-width: 1px;
        border-color: Theme.border-default;

        // Content layout
        VerticalBox {
            padding-top: 14px;
            padding-bottom: 12px;
            padding-left: 12px;
            padding-right: 12px;
            spacing: 8px;

            // Header with provider selector and buttons
            HorizontalBox {
                height: 32px;
                spacing: 8px;

                // Provider selector dropdown
                Text {
                    text: root.i18n-provider-label;
                    color: Theme.text-secondary;
                    font-size: 12px;
                    vertical-alignment: center;
                }

                ComboBox {
                    width: 120px;
                    model: root.provider-list;
                    current-index <=> root.current-provider-index;
                    selected(value) => {
                        root.provider-changed(root.current-provider-index);
                    }
                }

                // Spacer to push buttons to the right
                Rectangle {
                    horizontal-stretch: 1;
                }

                // Settings button
                Rectangle {
                    width: 28px;
                    height: 28px;
                    border-radius: 4px;
                    background: settings-touch.has-hover ? Theme.background-overlay : transparent;

                    Text {
                        text: "S";
                        color: settings-touch.has-hover ? Theme.text-primary : Theme.text-secondary;
                        font-size: 12px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }

                    settings-touch := TouchArea {
                        clicked => {
                            root.open-settings();
                        }
                    }
                }

                // Close button
                Rectangle {
                    width: 28px;
                    height: 28px;
                    border-radius: 4px;
                    background: close-touch.has-hover ? Theme.danger-surface : transparent;

                    Text {
                        text: "X";
                        color: close-touch.has-hover ? Theme.danger-text : Theme.text-secondary;
                        font-size: 14px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }

                    close-touch := TouchArea {
                        clicked => {
                            root.close-popup();
                        }
                    }
                }
            }

            // Source text display
            if root.source-text != "" : Rectangle {
                height: 32px;
                background: Theme.background-surface;
                border-radius: Theme.radius-small;
                border-width: 1px;
                border-color: Theme.border-subtle;

                HorizontalBox {
                    padding-left: 10px;
                    padding-right: 10px;

                    Text {
                        text: root.source-text;
                        color: Theme.text-secondary;
                        font-size: 11px;
                        overflow: elide;
                        vertical-alignment: center;
                    }
                }
            }

            // Loading indicator
            if root.loading : Rectangle {
                height: 50px;
                background: Theme.background-surface;
                border-radius: Theme.radius-medium;
                border-width: 1px;
                border-color: Theme.accent-subtle;

                HorizontalBox {
                    alignment: center;

                    Text {
                        text: root.i18n-translating;
                        color: Theme.accent-primary;
                        font-size: 13px;
                        vertical-alignment: center;
                    }
                }
            }

            // Error message
            if root.error-message != "" : Rectangle {
                background: Theme.danger-surface;
                border-radius: Theme.radius-small;
                border-width: 1px;
                border-color: Theme.danger-border;
                min-height: 36px;

                HorizontalBox {
                    padding: 8px;

                    Text {
                        text: root.error-message;
                        color: Theme.danger-text;
                        font-size: 11px;
                        wrap: word-wrap;
                        vertical-alignment: center;
                    }
                }
            }

            // Translation result
            if !root.loading && root.error-message == "" && root.translated-text != "" : Rectangle {
                background: result-touch.has-hover ? Theme.background-overlay : Theme.background-surface;
                border-radius: Theme.radius-medium;
                border-width: 1px;
                border-color: result-touch.has-hover ? Theme.accent-primary : Theme.border-subtle;
                min-height: 50px;
                animate background { duration: Theme.transition-normal; }
                animate border-color { duration: Theme.transition-normal; }

                VerticalBox {
                    padding: 10px;

                    Text {
                        text: root.translated-text;
                        color: Theme.text-primary;
                        font-size: 13px;
                        wrap: word-wrap;
                    }
                }

                // Click to apply
                result-touch := TouchArea {
                    mouse-cursor: pointer;
                    clicked => {
                        root.apply-translation();
                    }
                }
            }

            // Action buttons
            if !root.loading && root.translated-text != "" : HorizontalBox {
                alignment: end;
                spacing: 6px;
                height: 28px;

                // Copy button
                Rectangle {
                    width: 60px;
                    height: 26px;
                    border-radius: 4px;
                    background: copy-touch.has-hover ? Theme.background-overlay : Theme.background-surface;
                    border-width: 1px;
                    border-color: copy-touch.has-hover ? Theme.border-default : Theme.border-subtle;

                    Text {
                        text: root.i18n-copy;
                        color: copy-touch.has-hover ? Theme.text-primary : Theme.text-secondary;
                        font-size: 11px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }

                    copy-touch := TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            root.copy-result();
                        }
                    }
                }

                // Apply button (paste)
                Rectangle {
                    width: 60px;
                    height: 26px;
                    border-radius: 4px;
                    background: apply-touch.has-hover ? Theme.accent-hover : Theme.accent-primary;

                    Text {
                        text: root.i18n-apply;
                        color: #ffffff;
                        font-size: 11px;
                        font-weight: 600;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }

                    apply-touch := TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            root.apply-translation();
                        }
                    }
                }
            }

            // Hint text
            if !root.loading && root.translated-text != "" : Text {
                text: root.i18n-hint;
                color: Theme.text-muted;
                font-size: 9px;
                horizontal-alignment: center;
            }
        }
    }
}
