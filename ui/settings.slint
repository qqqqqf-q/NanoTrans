// NanoTrans Settings Window
// Modern, unified provider configuration

import { VerticalBox, HorizontalBox, LineEdit, ComboBox, ScrollView, TextEdit, CheckBox } from "std-widgets.slint";
import { Theme } from "./theme.slint";

// Hotkey input component - displays hotkey and triggers recording via Rust
component HotkeyInput inherits Rectangle {
    in-out property <string> hotkey: "Alt+Q";
    in property <string> placeholder: "Click to record...";
    in property <string> recording-text: "Press hotkey...";
    in-out property <bool> is-recording: false;

    callback clicked();

    height: 36px;
    background: is-recording ? Theme.accent-subtle : Theme.background-input;
    border-radius: Theme.radius-small;
    border-width: 1px;
    border-color: is-recording ? Theme.accent-primary : (touch.has-hover ? Theme.border-focus : Theme.border-subtle);

    animate border-color { duration: Theme.transition-normal; }
    animate background { duration: Theme.transition-normal; }

    HorizontalBox {
        padding-left: 12px;
        padding-right: 12px;

        Text {
            text: is-recording ? recording-text : (hotkey != "" ? hotkey : placeholder);
            color: is-recording ? Theme.accent-primary : (hotkey != "" ? Theme.text-primary : Theme.text-placeholder);
            font-size: Theme.font-size-body;
            font-family: Theme.font-family;
            vertical-alignment: center;
            horizontal-alignment: left;
        }
    }

    touch := TouchArea {
        mouse-cursor: pointer;
        clicked => {
            root.clicked();
        }
    }
}

// Section card component for consistent styling
component SectionCard inherits Rectangle {
    in property <string> title: "";

    background: Theme.background-elevated;
    border-radius: Theme.radius-medium;
    border-width: 1px;
    border-color: Theme.border-subtle;

    VerticalBox {
        padding: Theme.padding-medium;
        spacing: Theme.padding-small;

        if title != "" : Text {
            text: title;
            color: Theme.text-secondary;
            font-size: Theme.font-size-small;
            font-family: Theme.font-family;
            font-weight: 500;
        }

        @children
    }
}

export component SettingsWindow inherits Window {
    title: "NanoTrans Settings";
    width: 600px;
    height: 700px;
    background: Theme.background-main;
    default-font-family: Theme.font-family;
    default-font-size: Theme.font-size-body;

    // Properties
    in-out property <string> hotkey: "Alt+Q";
    in-out property <bool> hotkey-recording: false;
    in-out property <bool> hotkey-log-enabled: false;
    in-out property <int> provider-index: 0;
    in-out property <string> api-key: "";
    in-out property <string> api-base: "";
    in-out property <string> model: "";
    in property <[string]> provider-names: ["Google Translate", "DeepL", "Zhipu GLM", "OpenAI", "Anthropic", "Custom"];

    // Language selection
    in-out property <int> language-index: 0;
    in property <[string]> language-names: ["Auto", "English", "中文"];

    // Prompt presets (LLM)
    in-out property <int> prompt-preset-index: 0;
    in property <[string]> prompt-preset-names: ["默认（严格）", "更自然（轻润色）"];
    in-out property <string> prompt-preset-name: "";
    in-out property <string> prompt-system-template: "";
    in-out property <string> prompt-user-template: "";
    in property <bool> prompt-preset-deletable: false;

    // I18N text properties
    in property <string> i18n-title: "Settings";
    in property <string> i18n-hotkey: "Global Hotkey";
    in property <string> i18n-hotkey-placeholder: "Click and press keys...";
    in property <string> i18n-hotkey-recording: "Press hotkey...";
    in property <string> i18n-provider: "Translation Provider";
    in property <string> i18n-provider-settings: "Provider Settings";
    in property <string> i18n-google-hint: "Google Translate - no config needed";
    in property <string> i18n-deepl-settings: "DeepL Settings";
    in property <string> i18n-api-key: "API Key";
    in property <string> i18n-api-key-placeholder: "Enter your API key";
    in property <string> i18n-deepl-hint: "Get your free API key at deepl.com/pro-api";
    in property <string> i18n-api-settings: "API Settings";
    in property <string> i18n-api-base: "API Base URL";
    in property <string> i18n-model: "Model";
    in property <string> i18n-model-placeholder: "e.g., gpt-4o-mini";
    in property <string> i18n-apply: "Apply";
    in property <string> i18n-cancel: "Cancel";
    in property <string> i18n-language: "UI Language";
    in property <string> i18n-hotkey-log-title: "Local Logs";
    in property <string> i18n-hotkey-log-enable: "Enable hotkey log";
    in property <string> i18n-hotkey-log-hint: "Write hotkey debug logs to a local file";

    // Prompt i18n
    in property <string> i18n-prompt-settings: "Prompt Settings";
    in property <string> i18n-prompt-preset: "Preset";
    in property <string> i18n-prompt-add: "Add";
    in property <string> i18n-prompt-delete: "Delete";
    in property <string> i18n-prompt-name: "Preset Name";
    in property <string> i18n-prompt-system: "System Template";
    in property <string> i18n-prompt-user: "User Template";
    in property <string> i18n-prompt-vars: "Vars: {{target_lang_name}} {{target_lang_code}} {{text}}";

    // Callbacks
    callback cancel-settings();
    callback provider-selected(string);
    callback language-selected(string);
    callback start-hotkey-capture();
    callback prompt-preset-selected(string);
    callback add-prompt-preset();
    callback delete-prompt-preset();
    callback settings-changed();
    callback apply-api-settings();

    VerticalBox {
        padding: Theme.padding-large;
        spacing: Theme.padding-medium;

        // Title
        Text {
            text: root.i18n-title;
            color: Theme.text-primary;
            font-size: Theme.font-size-large;
            font-family: Theme.font-family;
            font-weight: 700;
        }

        ScrollView {
            viewport-height: content.preferred-height;

            content := VerticalBox {
                spacing: Theme.padding-medium;

                // UI Language
                SectionCard {
                    title: root.i18n-language;
                    height: 84px;

                    ComboBox {
                        model: root.language-names;
                        current-index <=> root.language-index;
                        selected(val) => {
                            root.language-selected(val);
                        }
                    }
                }

                // Hotkey
                SectionCard {
                    title: root.i18n-hotkey;
                    height: 84px;

                    hotkey-input := HotkeyInput {
                        hotkey <=> root.hotkey;
                        is-recording <=> root.hotkey-recording;
                        placeholder: root.i18n-hotkey-placeholder;
                        recording-text: root.i18n-hotkey-recording;
                        clicked => {
                            root.start-hotkey-capture();
                        }
                    }
                }

                // Hotkey log
                SectionCard {
                    title: root.i18n-hotkey-log-title;
                    height: 100px;

                    VerticalBox {
                        spacing: Theme.padding-xs;

                        CheckBox {
                            text: root.i18n-hotkey-log-enable;
                            checked <=> root.hotkey-log-enabled;
                            toggled => { root.settings-changed(); }
                        }

                        Text {
                            text: root.i18n-hotkey-log-hint;
                            color: Theme.text-placeholder;
                            font-size: Theme.font-size-small;
                            font-family: Theme.font-family;
                        }
                    }
                }

                // Provider Selection
                SectionCard {
                    title: root.i18n-provider;
                    height: 84px;

                    ComboBox {
                        model: root.provider-names;
                        current-index <=> root.provider-index;
                        selected(val) => {
                            root.provider-selected(val);
                        }
                    }
                }

                // Provider Config - Dynamic based on type
                SectionCard {
                    title: root.i18n-provider-settings;
                    vertical-stretch: 1;

                    VerticalBox {
                        spacing: 12px;

                        // Google - No config needed
                        if root.provider-index == 0 : Rectangle {
                            background: Theme.accent-subtle;
                            border-radius: Theme.radius-small;
                            height: 48px;
                            border-width: 1px;
                            border-color: Theme.accent-primary;

                            HorizontalBox {
                                padding: Theme.padding-small;
                                padding-left: 12px;
                                Text {
                                    text: root.i18n-google-hint;
                                    color: Theme.accent-primary;
                                    font-size: Theme.font-size-body;
                                    font-family: Theme.font-family;
                                    vertical-alignment: center;
                                }
                            }
                        }

                        // DeepL - Only API Key
                        if root.provider-index == 1 : VerticalBox {
                            spacing: 12px;

                            VerticalBox {
                                spacing: Theme.padding-xs;
                                Text {
                                    text: root.i18n-api-key;
                                    color: Theme.text-muted;
                                    font-size: Theme.font-size-small;
                                    font-family: Theme.font-family;
                                }
                                LineEdit {
                                    text <=> root.api-key;
                                    placeholder-text: root.i18n-api-key-placeholder;
                                    input-type: password;
                                    edited(text) => { root.settings-changed(); }
                                }
                            }

                            Text {
                                text: root.i18n-deepl-hint;
                                color: Theme.text-muted;
                                font-size: Theme.font-size-xs;
                                font-family: Theme.font-family;
                            }

                            HorizontalBox {
                                alignment: end;
                                height: 34px;

                                Rectangle {
                                    width: 70px;
                                    height: 34px;
                                    border-radius: Theme.radius-small;
                                    background: apply-deepl-area.has-hover ? Theme.background-overlay : Theme.background-surface;
                                    border-width: 1px;
                                    border-color: apply-deepl-area.has-hover ? Theme.border-default : Theme.border-subtle;
                                    animate background { duration: Theme.transition-fast; }
                                    animate border-color { duration: Theme.transition-fast; }

                                    Text {
                                        text: root.i18n-apply;
                                        color: apply-deepl-area.has-hover ? Theme.text-primary : Theme.text-secondary;
                                        font-size: Theme.font-size-small;
                                        font-family: Theme.font-family;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                        animate color { duration: Theme.transition-fast; }
                                    }

                                    apply-deepl-area := TouchArea {
                                        mouse-cursor: pointer;
                                        clicked => { root.apply-api-settings(); }
                                    }
                                }
                            }
                        }

                        // LLM Providers (Zhipu, OpenAI, Anthropic, Custom)
                        if root.provider-index >= 2 : VerticalBox {
                            spacing: 12px;

                            // API Base (only for Custom)
                            if root.provider-index == 5 : VerticalBox {
                                spacing: Theme.padding-xs;
                                Text {
                                    text: root.i18n-api-base;
                                    color: Theme.text-muted;
                                    font-size: Theme.font-size-small;
                                    font-family: Theme.font-family;
                                }
                                LineEdit {
                                    text <=> root.api-base;
                                    placeholder-text: "https://api.example.com/v1";
                                    edited(text) => { root.settings-changed(); }
                                }
                            }

                            // Model
                            VerticalBox {
                                spacing: Theme.padding-xs;
                                Text {
                                    text: root.i18n-model;
                                    color: Theme.text-muted;
                                    font-size: Theme.font-size-small;
                                    font-family: Theme.font-family;
                                }
                                LineEdit {
                                    text <=> root.model;
                                    placeholder-text: root.i18n-model-placeholder;
                                    edited(text) => { root.settings-changed(); }
                                }
                            }

                            // API Key
                            VerticalBox {
                                spacing: Theme.padding-xs;
                                Text {
                                    text: root.i18n-api-key;
                                    color: Theme.text-muted;
                                    font-size: Theme.font-size-small;
                                    font-family: Theme.font-family;
                                }
                                LineEdit {
                                    text <=> root.api-key;
                                    placeholder-text: root.i18n-api-key-placeholder;
                                    input-type: password;
                                    edited(text) => { root.settings-changed(); }
                                }
                            }

                            HorizontalBox {
                                alignment: end;
                                height: 34px;

                                Rectangle {
                                    width: 70px;
                                    height: 34px;
                                    border-radius: Theme.radius-small;
                                    background: apply-api-area.has-hover ? Theme.background-overlay : Theme.background-surface;
                                    border-width: 1px;
                                    border-color: apply-api-area.has-hover ? Theme.border-default : Theme.border-subtle;
                                    animate background { duration: Theme.transition-fast; }
                                    animate border-color { duration: Theme.transition-fast; }

                                    Text {
                                        text: root.i18n-apply;
                                        color: apply-api-area.has-hover ? Theme.text-primary : Theme.text-secondary;
                                        font-size: Theme.font-size-small;
                                        font-family: Theme.font-family;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                        animate color { duration: Theme.transition-fast; }
                                    }

                                    apply-api-area := TouchArea {
                                        mouse-cursor: pointer;
                                        clicked => { root.apply-api-settings(); }
                                    }
                                }
                            }
                        }
                    }
                }

                // Prompt presets (only affects LLM providers)
                SectionCard {
                    title: root.i18n-prompt-settings;

                    VerticalBox {
                        spacing: 12px;

                        HorizontalBox {
                            spacing: Theme.padding-small;
                            height: 36px;

                            Text {
                                text: root.i18n-prompt-preset;
                                color: Theme.text-muted;
                                font-size: Theme.font-size-small;
                                font-family: Theme.font-family;
                                vertical-alignment: center;
                            }

                            ComboBox {
                                horizontal-stretch: 1;
                                model: root.prompt-preset-names;
                                current-index <=> root.prompt-preset-index;
                                selected(val) => {
                                    root.prompt-preset-selected(val);
                                }
                            }

                            Rectangle {
                                width: 70px;
                                height: 34px;
                                border-radius: Theme.radius-small;
                                background: add-area.has-hover ? Theme.background-overlay : Theme.background-surface;
                                border-width: 1px;
                                border-color: add-area.has-hover ? Theme.border-default : Theme.border-subtle;
                                animate background { duration: Theme.transition-fast; }
                                animate border-color { duration: Theme.transition-fast; }

                                Text {
                                    text: root.i18n-prompt-add;
                                    color: add-area.has-hover ? Theme.text-primary : Theme.text-secondary;
                                    font-size: Theme.font-size-body;
                                    font-family: Theme.font-family;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                    animate color { duration: Theme.transition-fast; }
                                }

                                add-area := TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => { root.add-prompt-preset(); }
                                }
                            }

                            Rectangle {
                                width: 70px;
                                height: 34px;
                                border-radius: Theme.radius-small;
                                background: delete-area.has-hover && root.prompt-preset-deletable ? Theme.danger-surface : Theme.background-surface;
                                border-width: 1px;
                                border-color: delete-area.has-hover && root.prompt-preset-deletable ? Theme.danger-border : Theme.border-subtle;
                                animate background { duration: Theme.transition-fast; }
                                animate border-color { duration: Theme.transition-fast; }

                                Text {
                                    text: root.i18n-prompt-delete;
                                    color: root.prompt-preset-deletable ? (delete-area.has-hover ? Theme.danger-text : Theme.text-secondary) : Theme.text-placeholder;
                                    font-size: Theme.font-size-body;
                                    font-family: Theme.font-family;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                    animate color { duration: Theme.transition-fast; }
                                }

                                delete-area := TouchArea {
                                    mouse-cursor: root.prompt-preset-deletable ? pointer : default;
                                    clicked => {
                                        if (root.prompt-preset-deletable) {
                                            root.delete-prompt-preset();
                                        }
                                    }
                                }
                            }
                        }

                        VerticalBox {
                            spacing: Theme.padding-xs;
                            Text {
                                text: root.i18n-prompt-name;
                                color: Theme.text-muted;
                                font-size: Theme.font-size-small;
                                font-family: Theme.font-family;
                            }
                            LineEdit {
                                text <=> root.prompt-preset-name;
                                placeholder-text: "自定义 1";
                                edited(text) => { root.settings-changed(); }
                            }
                        }

                        VerticalBox {
                            spacing: Theme.padding-xs;
                            Text {
                                text: root.i18n-prompt-system;
                                color: Theme.text-muted;
                                font-size: Theme.font-size-small;
                                font-family: Theme.font-family;
                            }
                            TextEdit {
                                height: 120px;
                                text <=> root.prompt-system-template;
                                wrap: word-wrap;
                                edited(text) => { root.settings-changed(); }
                            }
                        }

                        VerticalBox {
                            spacing: Theme.padding-xs;
                            Text {
                                text: root.i18n-prompt-user;
                                color: Theme.text-muted;
                                font-size: Theme.font-size-small;
                                font-family: Theme.font-family;
                            }
                            TextEdit {
                                height: 100px;
                                text <=> root.prompt-user-template;
                                wrap: word-wrap;
                                edited(text) => { root.settings-changed(); }
                            }
                        }

                        Text {
                            text: root.i18n-prompt-vars;
                            color: Theme.text-placeholder;
                            font-size: Theme.font-size-small;
                            font-family: Theme.font-family;
                        }
                    }
                }
            }
        }

        // Buttons
        HorizontalBox {
            alignment: end;
            spacing: Theme.padding-small;
            height: 48px;

            Rectangle {
                width: 100px;
                height: 40px;
                border-radius: Theme.radius-small;
                background: cancel-area.has-hover ? Theme.background-overlay : Theme.background-surface;
                border-width: 1px;
                border-color: cancel-area.has-hover ? Theme.border-default : Theme.border-subtle;
                animate background { duration: Theme.transition-fast; }
                animate border-color { duration: Theme.transition-fast; }

                Text {
                    text: root.i18n-cancel;
                    color: cancel-area.has-hover ? Theme.text-primary : Theme.text-secondary;
                    font-size: Theme.font-size-body;
                    font-family: Theme.font-family;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    animate color { duration: Theme.transition-fast; }
                }

                cancel-area := TouchArea {
                    mouse-cursor: pointer;
                    clicked => { root.cancel-settings(); }
                }
            }
        }
    }
}
